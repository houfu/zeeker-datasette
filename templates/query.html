{% extends "default:query.html" %}

{% block extra_head %}
{{ super() }}
<meta name="description" content="SQL Query Interface - Singapore Legal Data">
{% endblock %}

{% block nav %}
{% include "_header.html" %}
{% endblock %}

{% block content %}
<div class="query-header">
  <div class="breadcrumbs">
    <a href="/">🏠 Home</a>
    <span class="separator">→</span>
    {% if database %}
    <a href="/{{ database }}">{{ database|title }}</a>
    <span class="separator">→</span>
    <span>SQL Query</span>
    {% else %}
    <span>SQL Query</span>
    {% endif %}
  </div>

  <div class="query-overview">
    <div class="query-summary">
      <h1 class="query-title">SQL Query Interface</h1>
      <p class="query-description">
        {% if database %}
        Write custom SQL queries against the {{ database }} database
        {% else %}
        Write custom SQL queries against the available databases
        {% endif %}
      </p>
    </div>
  </div>
</div>

{# Let Datasette handle the core query interface #}
{{ super() }}

<!-- SQL Examples Section -->
<section class="sql-examples-section">
  <div class="card">
    <h2>💻 SQL Examples</h2>
    {% if database %}
    <p>Ready-to-use queries for exploring the {{ database }} database:</p>
    {% else %}
    <p>Ready-to-use queries for exploring legal data:</p>
    {% endif %}

    <div class="examples-grid">
      <div class="example-card">
        <h4>📊 Database Schema</h4>
        <div class="example-box">
          <button class="copy-btn">📋</button>
          <pre><code>-- View all tables and their structure
SELECT name, sql
FROM sqlite_master
WHERE type = 'table'
ORDER BY name;</code></pre>
        </div>
        <p><em>Explore the complete database schema</em></p>
        {% set schema_url = "/" + (database if database else "sglawwatch") + "?sql=SELECT+name%2C+sql+FROM+sqlite_master+WHERE+type%3D%27table%27+ORDER+BY+name" %}
        <a href="{{ schema_url }}" class="try-button">🔗 Try This Query</a>
      </div>

      <div class="example-card">
        <h4>📈 Record Counts</h4>
        <div class="example-box">
          <button class="copy-btn">📋</button>
          <pre><code>-- Count records in each table
SELECT name as table_name
FROM sqlite_master
WHERE type = 'table'
  AND name != 'sqlite_sequence'
ORDER BY name;</code></pre>
        </div>
        <p><em>List all available tables</em></p>
        {% set count_url = "/" + (database if database else "sglawwatch") + "?sql=SELECT+name+as+table_name+FROM+sqlite_master+WHERE+type%3D%27table%27+AND+name+%21%3D+%27sqlite_sequence%27+ORDER+BY+name" %}
        <a href="{{ count_url }}" class="try-button">🔗 Try This Query</a>
      </div>

      {% if tables and tables|length > 0 %}
      {% set first_table = tables[0] %}
      <div class="example-card">
        <h4>🔍 Sample Data from {{ first_table.name|title }}</h4>
        <div class="example-box">
          <button class="copy-btn">📋</button>
          <pre><code>-- Get sample records from {{ first_table.name }}
SELECT *
FROM "{{ first_table.name }}"
LIMIT 20;</code></pre>
        </div>
        <p><em>Preview data from the {{ first_table.name }} table</em></p>
        {% set sample_url = "/" + (database if database else "sglawwatch") + "?sql=SELECT+*+FROM+%22" + first_table.name + "%22+LIMIT+20" %}
        <a href="{{ sample_url }}" class="try-button">🔗 Try This Query</a>
      </div>

      <div class="example-card">
        <h4>📊 Record Count for {{ first_table.name|title }}</h4>
        <div class="example-box">
          <button class="copy-btn">📋</button>
          <pre><code>-- Count total records in {{ first_table.name }}
SELECT COUNT(*) as total_records
FROM "{{ first_table.name }}";</code></pre>
        </div>
        <p><em>See how many records are in {{ first_table.name }}</em></p>
        {% set count_table_url = "/" + (database if database else "sglawwatch") + "?sql=SELECT+COUNT(*)+as+total_records+FROM+%22" + first_table.name + "%22" %}
        <a href="{{ count_table_url }}" class="try-button">🔗 Try This Query</a>
      </div>

      {% if first_table.columns %}
      {% set text_column = '' %}
      {% set date_column = '' %}
      {% for column in first_table.columns %}
        {% if not text_column and column.type|lower in ['text', 'varchar', 'string'] %}
          {% set text_column = column.name %}
        {% endif %}
        {% if not date_column and column.name|lower in ['date', 'created_at', 'updated_at', 'published', 'timestamp'] %}
          {% set date_column = column.name %}
        {% endif %}
      {% endfor %}

      {% if text_column %}
      <div class="example-card">
        <h4>🔍 Text Search in {{ first_table.name|title }}</h4>
        <div class="example-box">
          <button class="copy-btn">📋</button>
          <pre><code>-- Search for specific terms in {{ first_table.name }}
SELECT *
FROM "{{ first_table.name }}"
WHERE LOWER("{{ text_column }}") LIKE '%search_term%'
LIMIT 25;</code></pre>
        </div>
        <p><em>Find records containing specific keywords</em></p>
        {% set search_url = "/" + (database if database else "sglawwatch") + "?sql=SELECT+*+FROM+%22" + first_table.name + "%22+WHERE+LOWER(%22" + text_column + "%22)+LIKE+%27%25contract%25%27+LIMIT+25" %}
        <a href="{{ search_url }}" class="try-button">🔗 Try This Query</a>
      </div>
      {% endif %}

      {% if date_column %}
      <div class="example-card">
        <h4>📅 Recent Records from {{ first_table.name|title }}</h4>
        <div class="example-box">
          <button class="copy-btn">📋</button>
          <pre><code>-- Get recent records from {{ first_table.name }}
SELECT *
FROM "{{ first_table.name }}"
WHERE "{{ date_column }}" >= date('now', '-30 days')
ORDER BY "{{ date_column }}" DESC
LIMIT 20;</code></pre>
        </div>
        <p><em>See the most recent entries</em></p>
        {% set recent_url = "/" + (database if database else "sglawwatch") + "?sql=SELECT+*+FROM+%22" + first_table.name + "%22+WHERE+%22" + date_column + "%22+%3E%3D+date(%27now%27%2C+%27-30+days%27)+ORDER+BY+%22" + date_column + "%22+DESC+LIMIT+20" %}
        <a href="{{ recent_url }}" class="try-button">🔗 Try This Query</a>
      </div>
      {% endif %}
      {% endif %}

      {% else %}
      <div class="example-card">
        <h4>🔍 Sample Data Query</h4>
        <div class="example-box">
          <button class="copy-btn">📋</button>
          <pre><code>-- First, check what tables are available
SELECT name
FROM sqlite_master
WHERE type = 'table'
  AND name != 'sqlite_sequence';</code></pre>
        </div>
        <p><em>Find available tables, then query them</em></p>
        {% set sample_url = "/" + (database if database else "sglawwatch") + "?sql=SELECT+name+FROM+sqlite_master+WHERE+type%3D%27table%27+AND+name+%21%3D+%27sqlite_sequence%27" %}
        <a href="{{ sample_url }}" class="try-button">🔗 Try This Query</a>
      </div>
      {% endif %}

      <div class="example-card">
        <h4>🎯 Custom Query Template</h4>
        <div class="example-box">
          <button class="copy-btn">📋</button>
          <pre><code>-- Customize this template
SELECT
  -- Choose your columns
  *
FROM
  "your_table_name"
WHERE
  -- Add your conditions
  1=1
ORDER BY
  -- Sort your results
  1
LIMIT 50;</code></pre>
        </div>
        <p><em>Starting point for your own queries</em></p>
        {% set template_url = "/" + (database if database else "sglawwatch") + "?sql=SELECT+*+FROM+sqlite_master+WHERE+type%3D%27table%27+LIMIT+10" %}
        <a href="{{ template_url }}" class="try-button">🔗 Try This Query</a>
      </div>
    </div>

    <div class="tip-box">
      <h4>💡 SQL Tips</h4>
      <ul>
        <li><strong>Table names:</strong> Use double quotes for safety: <code>"table_name"</code></li>
        <li><strong>Text search:</strong> Use <code>LIKE '%keyword%'</code> for partial matches</li>
        <li><strong>Case-insensitive:</strong> Use <code>LOWER(column)</code> for text comparisons</li>
        <li><strong>Date filtering:</strong> Use <code>date >= '2024-01-01'</code> format</li>
        <li><strong>Sort results:</strong> Add <code>ORDER BY column_name DESC</code></li>
        <li><strong>Limit output:</strong> Always use <code>LIMIT</code> for large tables</li>
      </ul>
    </div>
  </div>
</section>

<!-- Query Tools Section -->
<section class="query-tools">
  <div class="card">
    <h2>🛠️ Query Tools</h2>

    <div class="tools-grid">
      <div class="tool">
        <h3>📊 Export Results</h3>
        <p>Download query results in various formats</p>
        <div class="export-options">
          <span class="btn disabled" id="json-export">JSON</span>
          <span class="btn disabled" id="csv-export">CSV</span>
          <small style="color: var(--color-text-muted); margin-top: 0.5rem; display: block;">Run a query first to enable exports</small>
        </div>
      </div>

      <div class="tool">
        <h3>🔍 Database Explorer</h3>
        <p>Browse available databases and tables</p>
        <div class="context-actions">
          <a href="/" class="btn">Browse All Databases</a>
          {% if database %}
          <a href="/{{ database }}" class="btn">{{ database|title }} Tables</a>
          {% endif %}
        </div>
      </div>

      <div class="tool">
        <h3>📚 Documentation</h3>
        <p>Learn more about using SQL with legal data</p>
        <div class="context-actions">
          <a href="/how-to-use" class="btn">How to Use Guide</a>
          <a href="/sources" class="btn">Data Sources</a>
        </div>
      </div>

      <div class="tool">
        <h3>🔗 Global Search</h3>
        <p>Search across all legal databases</p>
        <div class="context-actions">
          <a href="/-/search" class="btn">Full-Text Search</a>
        </div>
      </div>

      <div class="tool">
        <h3>📋 Query Examples</h3>
        <p>Common patterns for legal data analysis</p>
        <div class="context-actions">
          {% if database %}
          <a href="/{{ database }}" class="btn">Database Examples</a>
          {% endif %}
          <a href="/how-to-use#sql-for-legal-researchers" class="btn">SQL Tutorial</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- SQL Help Section -->
<section class="sql-help">
  <div class="card">
    <h2>ℹ️ SQL Help</h2>

    <div class="help-sections">
      <div class="help-section">
        <h4>🎯 Legal Data Query Tips</h4>
        <ul>
          <li>Use <code>LIKE '%keyword%'</code> for text searches</li>
          <li>Filter by date: <code>WHERE date BETWEEN '2023-01-01' AND '2024-01-01'</code></li>
          <li>Group by categories: <code>GROUP BY category</code></li>
          <li>Order by relevance: <code>ORDER BY date DESC, title ASC</code></li>
          <li>Limit results: <code>LIMIT 100</code> for better performance</li>
        </ul>
      </div>

      <div class="help-section">
        <h4>🔧 SQLite Functions</h4>
        <ul>
          <li><code>strftime('%Y', date)</code> - Extract year from date</li>
          <li><code>LENGTH(text)</code> - Get text length</li>
          <li><code>UPPER(text)</code> - Convert to uppercase</li>
          <li><code>COUNT(*)</code> - Count rows</li>
          <li><code>DISTINCT column</code> - Get unique values</li>
        </ul>
      </div>

      <div class="help-section">
        <h4>📊 Common Patterns</h4>
        <ul>
          <li>Text search: <code>WHERE LOWER(column) LIKE '%term%'</code></li>
          <li>Date range: <code>WHERE date >= '2024-01-01'</code></li>
          <li>Multiple conditions: <code>WHERE condition1 AND condition2</code></li>
          <li>Null checks: <code>WHERE column IS NOT NULL</code></li>
          <li>Top results: <code>ORDER BY count DESC LIMIT 10</code></li>
        </ul>
      </div>
    </div>
  </div>
</section>

<script>
// Enable export buttons when there are results
document.addEventListener('DOMContentLoaded', function() {
    // Check if there are query results on the page
    const resultsTable = document.querySelector('.query-results-table, table.rows-and-columns');
    const jsonExport = document.getElementById('json-export');
    const csvExport = document.getElementById('csv-export');

    if (resultsTable && jsonExport && csvExport) {
        // Enable export buttons and make them links
        const currentUrl = window.location.href;
        const baseUrl = currentUrl.split('?')[0];
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.has('sql')) {
            const sql = urlParams.get('sql');

            // Create export URLs
            const jsonUrl = baseUrl + '.json?sql=' + encodeURIComponent(sql);
            const csvUrl = baseUrl + '.csv?sql=' + encodeURIComponent(sql);

            // Convert spans to links
            jsonExport.outerHTML = `<a href="${jsonUrl}" class="btn">JSON</a>`;
            csvExport.outerHTML = `<a href="${csvUrl}" class="btn">CSV</a>`;

            // Remove the disabled message
            const message = jsonExport.parentElement.querySelector('small');
            if (message) message.remove();
        }
    }
});
</script>
{% endblock %}